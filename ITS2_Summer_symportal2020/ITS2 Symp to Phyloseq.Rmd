---
title: "ITS2 Symportal to phyloseq"
author: "Shayle Matsuda"
date: "6/27/2022"
output: html_document
---

This is a script taking the Symportal output and oragnizing it into phyloseq ready objects

* load in all data. Use the raw reads to view seqs and then create rarefied relative abundance df yourself
```{r}
#rm(list=ls())

library(tidyverse)
library(readxl)
library(phyloseq)
library(janitor)
library("writexl")

setwd("~/Desktop/Microbial landscape/R/Mcapitata_microbial_landscape/ITS2_Summer_symportal2020")
```
Reading in data with Ross code, this is relA. 


# Relative Abundance 
Read in coral ITS2 profiles: "coral"
```{r}  
#add metadata to symportal submission data
Symp_sub<-readxl::read_xlsx("MCL_SymPortal_submission_input.xlsx", skip = 1)
Metadata<-read.csv("MCL19_metadata_20220621.csv")
Metadata<-rename(Metadata, sample_name=UNIQUEID) #rename UNIQUEID column to sample_name
propCD<-read.csv("propCD.csv")
Metadata<-left_join(Metadata, propCD, by="Sample_name")
#add Prop.C and Prop.D to the metadata (issues with phyloseq drove you to do this at this stage)



Symp_sub_Meta<-left_join(Symp_sub, Metadata, by="sample_name") # merge
#save in correct format:
write_xlsx(Symp_sub_Meta,"MCL_Symp_Metadata_20220621.xlsx")

sam0 <- readxl::read_xlsx("MCL_Symp_Metadata_20220621.xlsx") #Symportal metadata combined from above
sam1 <- as.matrix(sam0[, -1])
rownames(sam1) <- sam0$sample_name
sam <- sample_data(data.frame(sam1))

tax0 <- read_tsv(
  file  = "20201214_matsuda_MCL/its2_type_profiles/133_20201216_DBV_20201216T011417.profiles.relative.abund_and_meta.txt",
  n_max = 6) %>%
  dplyr::select(-2) %>% 
  gather(UID, value, -1) %>% 
  spread(1, value) %>%
  clean_names()

tax1 <- as.matrix(tax0[, -1], dimnames = list(tax0$uid, colnames(tax0[-1])))
rownames(tax1) <- tax0$uid
tax <- tax_table(tax1)

otu0 <- read_tsv(
  file  = "20201214_matsuda_MCL/its2_type_profiles/133_20201216_DBV_20201216T011417.profiles.relative.abund_and_meta.txt") %>% 
  rename(sample_name = ...2) %>% #rename column "...2", previously "X2" in symportal language
  select(-1) %>%
  slice(7:n()) %>%
  mutate_at(2:ncol(.), as.numeric)
otu1 <- as.matrix(otu0[, -1])
rownames(otu1) <- otu0$sample_name
otu <- otu_table(otu1, taxa_are_rows = FALSE)

coral <- phyloseq(otu, tax, sam)
 
sample_data(coral)$Prop.D <- as.numeric(sample_data(coral)$Prop.D)
sample_data(coral)$Prop.C <- as.numeric(sample_data(coral)$Prop.C)
sample_data(coral)$Location <- as.factor(sample_data(coral)$Location)
sample_data(coral)$TagID <- as.factor(sample_data(coral)$TagID)
sample_data(coral)$Depth.ft <- as.numeric(sample_data(coral)$Depth.ft)
sample_data(coral)$Samp.Date <- as.Date(sample_data(coral)$Samp.Date)
sample_data(coral)$Land_Ocean <- as.factor(sample_data(coral)$Land_Ocean)
sample_data(coral)$SampleNum <- as.factor(sample_data(coral)$SampleNum)
sample_data(coral)$SampLoc <- as.factor(sample_data(coral)$SampLoc)
sample_data(coral)$BranchLoc <- as.factor(sample_data(coral)$BranchLoc)
sample_data(coral)$branch.plate <- as.factor(sample_data(coral)$branch.plate)
sample_data(coral)$Sample_name <- as.factor(sample_data(coral)$Sample_name)
sample_data(coral)$Zoox <- as.factor(sample_data(coral)$Zoox)
sample_data(coral)$LocSamp <- as.factor(sample_data(coral)$LocSamp)



```
Read in coral post-QC sequence variants: "coralDIV"
```{r}  
sam0 <- read_xlsx("MCL_Symp_Metadata_20220621.xlsx")
sam1 <- as.matrix(sam0[, -1])
rownames(sam1) <- sam0$sample_name
sam <- sample_data(data.frame(sam1))


taxnames <- read_tsv(
  file  = "20201214_matsuda_MCL/post_med_seqs/133_20201216_DBV_20201216T011417.seqs.relative.abund_only.txt",
  n_max = 0) %>%
  select(-1) %>%
  names(.)
tax0 <- data_frame(
  DIV = taxnames,
  clade = str_extract(DIV, "[A-Z]")
)
tax1 <- as.matrix(tax0)
rownames(tax1) <- tax0$DIV
tax <- tax_table(tax1)
otu0 <- read_tsv(
  file  = "20201214_matsuda_MCL/post_med_seqs/133_20201216_DBV_20201216T011417.seqs.relative.abund_and_meta.txt") %>%
  select(-1, -(3:33))
otu1 <- as.matrix(otu0[, -1])
rownames(otu1) <- otu0$sample_name
otu <- otu_table(otu1, taxa_are_rows = FALSE)
coralDIV <- phyloseq(otu, tax, sam)

sample_data(coralDIV)$Prop.D <- as.numeric(sample_data(coralDIV)$Prop.D)
sample_data(coralDIV)$Prop.C <- as.numeric(sample_data(coralDIV)$Prop.C)
sample_data(coralDIV)$Location <- as.factor(sample_data(coralDIV)$Location)
sample_data(coralDIV)$TagID <- as.factor(sample_data(coralDIV)$TagID)
sample_data(coralDIV)$Depth.ft <- as.numeric(sample_data(coralDIV)$Depth.ft)
sample_data(coralDIV)$Samp.Date <- as.Date(sample_data(coralDIV)$Samp.Date)
sample_data(coralDIV)$Land_Ocean <- as.factor(sample_data(coralDIV)$Land_Ocean)
sample_data(coralDIV)$SampleNum <- as.factor(sample_data(coralDIV)$SampleNum)
sample_data(coralDIV)$SampLoc <- as.factor(sample_data(coralDIV)$SampLoc)
sample_data(coralDIV)$BranchLoc <- as.factor(sample_data(coralDIV)$BranchLoc)
sample_data(coralDIV)$branch.plate <- as.factor(sample_data(coralDIV)$branch.plate)
sample_data(coralDIV)$Sample_name <- as.factor(sample_data(coralDIV)$Sample_name)
sample_data(coralDIV)$Zoox <- as.factor(sample_data(coralDIV)$Zoox)
sample_data(coralDIV)$LocSamp <- as.factor(sample_data(coralDIV)$LocSamp)

```

```{r} 
save(coral, coralDIV, file = "data/coral_phyloseq_2022.RData")
```

#Reading in data by ABSOLUTE abundances
This is the same as above just by absolute 

Profiles Absolute
```{r}
 
sam0 <- readxl::read_xlsx("MCL_Symp_Metadata_20220621.xlsx") #Symportal metadata combined from above
# make all factors
cols <- c("sample_type", "TagID", "Colony.Color", "Samp.Date","Land_Ocean","SampLoc","BranchLoc","Zoox","Location")
sam0[cols] <- lapply(sam0[cols], factor)  ## as.factor() could also be used
sam1 <- as.matrix(sam0[, -1])
rownames(sam1) <- sam0$sample_name
sam <- sample_data(data.frame(sam1))

tax0 <- read_tsv(
  file  = "20201214_matsuda_MCL/its2_type_profiles/133_20201216_DBV_20201216T011417.profiles.absolute.abund_and_meta.txt",
  n_max = 6) %>%
  dplyr::select(-2) %>% 
  gather(UID, value, -1) %>% 
  spread(1, value) %>%
  clean_names()

tax1 <- as.matrix(tax0[, -1], dimnames = list(tax0$uid, colnames(tax0[-1])))
rownames(tax1) <- tax0$uid
tax <- tax_table(tax1)

otu0 <- read_tsv(
  file  = "20201214_matsuda_MCL/its2_type_profiles/133_20201216_DBV_20201216T011417.profiles.absolute.abund_and_meta.txt") %>% 
  rename(sample_name = ...2) %>%
  select(-1) %>%
  slice(7:n()) %>%
  mutate_at(2:ncol(.), as.numeric)
otu1 <- as.matrix(otu0[, -1])
rownames(otu1) <- otu0$sample_name
otu <- otu_table(otu1, taxa_are_rows = FALSE)

coral_absolutePro <- phyloseq(otu, tax, sam)

sample_data(coral_absolutePro)$Prop.D <- as.numeric(sample_data(coral_absolutePro)$Prop.D)
sample_data(coral_absolutePro)$Prop.C <- as.numeric(sample_data(coral_absolutePro)$Prop.C)
sample_data(coral_absolutePro)$Location <- as.factor(sample_data(coral_absolutePro)$Location)
sample_data(coral_absolutePro)$TagID <- as.factor(sample_data(coral_absolutePro)$TagID)
sample_data(coral_absolutePro)$Depth.ft <- as.numeric(sample_data(coral_absolutePro)$Depth.ft)
sample_data(coral_absolutePro)$Samp.Date <- as.Date(sample_data(coral_absolutePro)$Samp.Date)
sample_data(coral_absolutePro)$Land_Ocean <- as.factor(sample_data(coral_absolutePro)$Land_Ocean)
sample_data(coral_absolutePro)$SampleNum <- as.factor(sample_data(coral_absolutePro)$SampleNum)
sample_data(coral_absolutePro)$SampLoc <- as.factor(sample_data(coral_absolutePro)$SampLoc)
sample_data(coral_absolutePro)$BranchLoc <- as.factor(sample_data(coral_absolutePro)$BranchLoc)
sample_data(coral_absolutePro)$branch.plate <- as.factor(sample_data(coral_absolutePro)$branch.plate)
sample_data(coral_absolutePro)$Sample_name <- as.factor(sample_data(coral_absolutePro)$Sample_name)
sample_data(coral_absolutePro)$Zoox <- as.factor(sample_data(coral_absolutePro)$Zoox)
sample_data(coral_absolutePro)$LocSamp <- as.factor(sample_data(coral_absolutePro)$LocSamp)

```
DIVs absolute
```{r} 

taxnames <- read_tsv(
  file  = "20201214_matsuda_MCL/post_med_seqs/133_20201216_DBV_20201216T011417.seqs.absolute.abund_only.txt",
  n_max = 0) %>%
  select(-1) %>%
  names(.)
tax0 <- data_frame(
  DIV = taxnames,
  clade = str_extract(DIV, "[A-Z]")
)
tax1 <- as.matrix(tax0)
rownames(tax1) <- tax0$DIV
tax <- tax_table(tax1)
otu0 <- read_tsv(
  file  = "20201214_matsuda_MCL/post_med_seqs/133_20201216_DBV_20201216T011417.seqs.absolute.abund_and_meta.txt") %>%
  select(-1, -(3:33))
otu1 <- as.matrix(otu0[, -1])
rownames(otu1) <- otu0$sample_name
otu <- otu_table(otu1, taxa_are_rows = FALSE)
coral_Absolute_DIV <- phyloseq(otu, tax, sam)

sample_data(coral_Absolute_DIV)$Prop.D <- as.numeric(sample_data(coral_Absolute_DIV)$Prop.D)
sample_data(coral_Absolute_DIV)$Prop.C <- as.numeric(sample_data(coral_Absolute_DIV)$Prop.C)
sample_data(coral_Absolute_DIV)$Location <- as.factor(sample_data(coral_Absolute_DIV)$Location)
sample_data(coral_Absolute_DIV)$TagID <- as.factor(sample_data(coral_Absolute_DIV)$TagID)
sample_data(coral_Absolute_DIV)$Depth.ft <- as.numeric(sample_data(coral_Absolute_DIV)$Depth.ft)
sample_data(coral_Absolute_DIV)$Samp.Date <- as.Date(sample_data(coral_Absolute_DIV)$Samp.Date)
sample_data(coral_Absolute_DIV)$Land_Ocean <- as.factor(sample_data(coral_Absolute_DIV)$Land_Ocean)
sample_data(coral_Absolute_DIV)$SampleNum <- as.factor(sample_data(coral_Absolute_DIV)$SampleNum)
sample_data(coral_Absolute_DIV)$SampLoc <- as.factor(sample_data(coral_Absolute_DIV)$SampLoc)
sample_data(coral_Absolute_DIV)$BranchLoc <- as.factor(sample_data(coral_Absolute_DIV)$BranchLoc)
sample_data(coral_Absolute_DIV)$branch.plate <- as.factor(sample_data(coral_Absolute_DIV)$branch.plate)
sample_data(coral_Absolute_DIV)$Sample_name <- as.factor(sample_data(coral_Absolute_DIV)$Sample_name)
sample_data(coral_Absolute_DIV)$Zoox <- as.factor(sample_data(coral_Absolute_DIV)$Zoox)
sample_data(coral_Absolute_DIV)$LocSamp <- as.factor(sample_data(coral_Absolute_DIV)$LocSamp)

```
Save as an obj
```{r}
save(coral_absolutePro, coral_Absolute_DIV, file = "data/Absolute_coral_phyloseq2022.RData")
```


